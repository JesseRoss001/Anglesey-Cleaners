{% extends "users/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container">
    <h2>Cleaner Dashboard</h2>
    <form method="post">
        {% csrf_token %}
        {{ rate_form|crispy }}
        <button type="submit" name="update_rates" class="btn btn-primary">Update Rates</button>
    </form>
    <hr>
    <div id='calendar'></div>
</div>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core/main.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid/main.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid/main.css" rel="stylesheet">

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid/main.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
      plugins: [ 'interaction', 'dayGrid', 'timeGrid' ],
      initialView: 'timeGridWeek',
      slotMinTime: '06:00:00',
      slotMaxTime: '22:00:00',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      expandRows: true,
      selectable: true,
      selectMirror: true,
      select: function(info) {
        // Here, you would typically open a modal or display a form
        // to add or edit an event (availability slot)
        alert('Selected timeslot: ' + info.startStr + ' to ' + info.endStr);
      },
      events: '{% url 'bookings:get_events' %}',
      eventClick: function(info) {
        // Here, you can handle event (availability slot) clicks, e.g., to edit
        alert('Event: ' + info.event.title);
      },
      editable: true,
      eventResizableFromStart: true,
      eventDrop: function(info) {
        // Handle event drops (move to a different time)
      },
      eventResize: function(info) {
        // Handle event resizes (change duration)
      }
    });

    calendar.render();

    // Function to handle CSRF token for POST AJAX calls
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Set up AJAX headers for CSRF token
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!settings.crossDomain && settings.url.indexOf(window.location.origin) === 0) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });
  });
</script>
{% endblock %}