{% extends "users/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block head %}
<!-- Bootstrap CSS for that sweet responsive grid and form styling -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
    body {
        font-family: 'Arial', sans-serif; /* Classic, like a little black dress */
    }
    .container {
        max-width: 1200px; /* Spacious yet cozy */
        margin: auto; /* Centered, as all things should be */
        padding: 20px; /* Breathing room */
    }
    /* Navigation but make it fashion */
    .week-navigation {
        text-align: center;
        margin-bottom: 30px;
    }
    .week-navigation a {
        background-color: #007bff; /* Blue as the deepest ocean */
        color: white; /* Pure as snow */
        padding: 10px 20px; /* Comfortably plump */
        border-radius: 5px; /* Soft edges for a harsh world */
        text-decoration: none; /* Naked links are a sin */
        margin: 0 10px; /* Personal space is important */
    }
    .week-navigation a:hover {
        background-color: #0056b3; /* Darker, like my soul */
    }
    /* Cards, because information deserves a throne */
    .card {
        border: 1px solid #ddd; /* Subtle, like a whisper */
        margin-bottom: 20px; /* Room to breathe */
        border-radius: 5px; /* Gentle curves */
        background-color: white; /* Blank canvases to paint your dreams on */
    }
    /* Forms, the unsung heroes of interaction */
    .form-group {
        margin-bottom: 15px; /* Orderly and spaced */
    }
    /* The overlay, a veil of anticipation */
    .loading-overlay {
        display: none; /* Shy until called upon */
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* Mystery and style */
        justify-content: center;
        align-items: center;
        z-index: 1050; /* Above all, yet beneath your touch */
    }
    .loading-overlay.active {
        display: flex; /* Behold, I am revealed */
    }
    /* The transformation, a dance of elements */
    .availability-updated {
        background-color: #28a745; /* Green, for go, grow, and glory */
        color: white; /* Contrast, my dear */
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2>Set Your Availability</h2>
    <div id="week-navigation" class="week-navigation">
        <a href="{% url 'bookings:cleaner_dashboard' %}?week={{ prev_week }}" class="btn btn-primary">Previous Week</a>
        <a href="{% url 'bookings:cleaner_dashboard' %}" class="btn btn-primary">Current Week</a>
        <a href="{% url 'bookings:cleaner_dashboard' %}?week={{ next_week }}" class="btn btn-primary">Next Week</a>
    </div>
    <div class="row">
{% for date, form in forms %}
<div class="col-md-4">
    <div class="card">
        <div class="card-header">
            {{ date|date:"F d, Y" }} <!-- This should display the date -->
        </div>
        <div class="card-body">
            <form method="post" class="availability-form" action="{% url 'bookings:cleaner_dashboard' %}">
                {% csrf_token %}
                <!-- Ensure the name attribute includes the form prefix -->
                <input type="hidden" name="{{ form.prefix }}-date" value="{{ date|date:'Y-m-d' }}">
                {% for field in form %}
                <div class="form-group">
                    <!-- Make sure to exclude the date field from this loop -->
                    {% if field.name != 'date' %}
                        {{ field.errors }}
                        {{ field.label_tag }}
                        {{ field }}
                    {% endif %}
                </div>
                {% endfor %}
                <button type="submit" class="btn btn-primary">Update</button>
            </form>
        </div>
    </div>
</div>
{% endfor %}
    </div>
</div>
<div class="loading-overlay" id="loading-overlay">
    <div>Loading...</div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.availability-form').forEach(function(form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(form);

            document.getElementById('loading-overlay').classList.add('active');

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loading-overlay').classList.remove('active');
                if(data.success) {
                    alert('Availability updated successfully.');
                    window.location.reload();
                } else {
                    // Display form errors
                    let errorMessages = '';
                    for (const [field, errors] of Object.entries(data.errors)) {
                        errorMessages += `${field}: ${errors.map(e => e.message).join(', ')}\n`;
                    }
                    alert(`Failed to update availability. Errors:\n${errorMessages}`);
                }
            })
            .catch(error => {
                document.getElementById('loading-overlay').classList.remove('active');
                console.error('Fetch error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}